<section id="CAREER">
    <div class="container">
        <div class="timeline-container">
            <div class="timeline">
                {% for event in career_timeline %}
                <div class="timeline-item" data-id="{{ loop.index }}" tabindex="0">
                    <div class="timeline-dot"></div>
                    <div class="timeline-header">
                        <div class="meta">
                            <div class="date">{{ event.start_date }}</div>
                        </div>
                        <div class="meta">
                            <div class="company">{{ event.company_name }}</div>
                            {% if event.location %}
                            <div class="location">â€¢ {{ event.location }}</div>
                            {% endif %}
                        </div>
                        <h2 class="position">{{ event.title }}</h2>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="detail-panel">
                <div class="detail-content" id="detail-content">
                    <!-- default content - will be replaced by job details -->
                </div>
            </div>
        </div>
    </div>

    {% for event in career_timeline %}
    <template id="job-details-{{ loop.index }}">
        <div class="timeline-content">
            <div class="job-description">
                <p>{{ event.description }}</p>
                <div class="tech-stack">
                    <div class="tech-icons-container">
                        <div class="tech-icons-scroll">
                            <div class="tech-icon">
                                <span class="iconify" data-icon="simple-icons:graphql" data-inline="false"></span>
                                <span class="tech-icon-name">graphql</span>
                            </div>
                            <div class="tech-icon">
                                <span class="iconify" data-icon="simple-icons:react" data-inline="false"></span>
                                <span class="tech-icon-name">react</span>
                            </div>
                            <div class="tech-icon">
                                <span class="iconify" data-icon="simple-icons:typescript" data-inline="false"></span>
                                <span class="tech-icon-name">typescript</span>
                            </div>
                            <div class="tech-icon">
                                <span class="iconify" data-icon="mdi:chart-line" data-inline="false"></span>
                                <span class="tech-icon-name">recharts</span>
                            </div>
                            <div class="tech-icon">
                                <span class="iconify" data-icon="simple-icons:postgresql" data-inline="false"></span>
                                <span class="tech-icon-name">postgresql</span>
                            </div>
                            <div class="tech-icon">
                                <span class="iconify" data-icon="simple-icons:flask" data-inline="false"></span>
                                <span class="tech-icon-name">flask</span>
                            </div>
                            <div class="tech-icon">
                                <span class="iconify" data-icon="mdi:server" data-inline="false"></span>
                                <span class="tech-icon-name">pgadmin</span>
                            </div>
                            <div class="tech-icon">
                                <span class="iconify" data-icon="simple-icons:elasticsearch" data-inline="false"></span>
                                <span class="tech-icon-name">elasticsearch</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="job-badge">
                    {% if event.is_current %}
                    <span class="current-badge">current</span>
                    {% endif %}
                    {% if event.is_remote %}
                    <span class="remote-badge">remote</span>
                    {% endif %}
                </div>
            </div>
        </div>
        {% if event.topics and event.topics|length > 0 %}
        <div class="topic-grid">
            {% for topic in event.topics %}
            <div class="topic-card" tabindex="0">
                <div class="topic-header">
                    <h3 class="topic-name">{{ topic.name }}</h3>
                    <div class="animated-terminal-icon">
                        <div class="terminal-header">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <div class="terminal-content">
                            <span class="typed-text"></span>
                            <span class="terminal-cursor"></span>
                        </div>
                    </div>
                </div>
                <div class="topic-details">
                    <p>{{ topic.description }}</p>
                    {% if topic.tags and topic.tags|length > 0 %}
                    <div class="topic-tags">
                        {% for tag in topic.tags %}
                        <span class="topic-tag">{{ tag }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% include "components/animated_icons/commitaura.html" %}
    </template>
    {% endfor %}

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const timeline = document.querySelector('#CAREER .timeline');
            const detailContent = document.getElementById('detail-content');
            const timelineItems = Array.from(document.querySelectorAll('#CAREER .timeline-item'));

            // update topic-cards-count css variable based on current topic cards
            function updateTopicCardsCount() {
                const count = document.querySelectorAll('#CAREER .topic-card').length;
                document.documentElement.style.setProperty('--topic-cards-count', count);
            }

            // insert timeline animation styles (only once)
            if (!document.getElementById('career-timeline-styles')) {
                const styleEl = document.createElement('style');
                styleEl.id = 'career-timeline-styles';
                styleEl.innerHTML = `
          #CAREER .timeline { --active-line-height: 0px; }
          #CAREER .timeline::after {
            content: '';
            position: absolute;
            top: 0;
            left: 15px;
            width: 2px;
            height: var(--active-line-height);
            background-color: var(--color-text-secondary);
            z-index: 2;
            transition: height 0.6s cubic-bezier(0.165,0.84,0.44,1);
          }
          .timeline-enter { animation: slideinleft 0.8s cubic-bezier(0.165,0.84,0.44,1); }
          @keyframes slideinleft { from { opacity:0; transform:translateX(-30px); } to { opacity:1; transform:translateX(0); } }
          .item-enter { animation: fadeinitem 0.5s cubic-bezier(0.165,0.84,0.44,1); }
          @keyframes fadeinitem { from { opacity:0; transform:translateX(-20px); } to { opacity:0.7; transform:translateX(0); } }
          .ripple-effect {
            position: absolute;
            border-radius: 50%;
            background-color: rgba(255,255,255,0.3);
            width: 10px; height: 10px;
            left: 15px; top: 10px;
            transform: translate(-50%,-50%) scale(0);
            animation: ripple 1s cubic-bezier(0.165,0.84,0.44,1);
            pointer-events: none;
          }
          @keyframes ripple { 0% { transform:translate(-50%,-50%) scale(0); opacity:0.8; } 100% { transform:translate(-50%,-50%) scale(20); opacity:0; } }
          .timeline-item.active .timeline-dot::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: rgba(255,255,255,0.4);
            animation: pulse 1.5s cubic-bezier(0.165,0.84,0.44,1) infinite;
            z-index: -1;
          }
          @keyframes pulse { 0% { transform:scale(1); opacity:0.8; } 70% { transform:scale(2); opacity:0; } 100% { transform:scale(2.5); opacity:0; } }
          .job-meta-header { animation: slideinright 0.5s cubic-bezier(0.165,0.84,0.44,1); }
          @keyframes slideinright { from { opacity:0; transform:translateX(-20px); } to { opacity:1; transform:translateX(0); } }
          .job-title, .job-meta, .job-description, .topics-heading { animation: fadeup 0.5s cubic-bezier(0.165,0.84,0.44,1); }
          @keyframes fadeup { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        `;
                document.head.appendChild(styleEl);
            }

            function setActiveItem(item, animate = true) {
                timelineItems.forEach(el => el.classList.remove('active'));
                item.classList.add('active');
                updateActiveLine(item);
                const dataId = item.getAttribute('data-id');
                const template = document.getElementById(`job-details-${dataId}`);
                if (template) {
                    const content = template.content.cloneNode(true);
                    detailContent.innerHTML = '';
                    detailContent.appendChild(content);
                    updateTopicCardsCount();
                    if (animate) {
                        detailContent.classList.add('content-fade-in');
                        setTimeout(() => detailContent.classList.remove('content-fade-in'), 600);
                    }
                    animateTopicCards();
                    initTechStack(); // reinit tech icons in new detail content
                }
            }

            function updateActiveLine(activeItem) {
                const dotRect = activeItem.querySelector('.timeline-dot').getBoundingClientRect();
                const tlRect = timeline.getBoundingClientRect();
                const lineHeight = (dotRect.top - tlRect.top) + (dotRect.height / 2);
                timeline.style.setProperty('--active-line-height', `${lineHeight}px`);
            }

            function animateTopicCards() {
                const cards = document.querySelectorAll('#CAREER .topic-card');
                cards.forEach((card, idx) => {
                    card.classList.remove('animate-in');
                    void card.offsetWidth;
                    setTimeout(() => card.classList.add('animate-in'), idx * 100);
                });
            }

            function initTechStack() {
                const scrollContainer = document.querySelector('.tech-icons-scroll');
                if (!scrollContainer) return;
                scrollContainer.style.animation = 'none';
                scrollContainer.offsetHeight;
                const icons = Array.from(scrollContainer.querySelectorAll('.tech-icon'));
                if (!icons.length) return;
                const origCount = icons.length;
                while (scrollContainer.children.length > origCount) {
                    scrollContainer.removeChild(scrollContainer.lastChild);
                }
                icons.forEach(icon => {
                    scrollContainer.appendChild(icon.cloneNode(true));
                });
                setTimeout(() => { scrollContainer.style.animation = 'scrollIcons 30s linear infinite'; }, 10);
            }

            // add individual keydown listener on document for arrow navigation
            document.addEventListener('keydown', (e) => {
                const active = document.querySelector('#CAREER .timeline-item.active');
                if (!active) return;
                const idx = timelineItems.indexOf(active);
                if (e.key === 'arrowdown' && idx < timelineItems.length - 1) {
                    e.preventDefault();
                    setActiveItem(timelineItems[idx + 1]);
                    timelineItems[idx + 1].focus();
                } else if (e.key === 'arrowup' && idx > 0) {
                    e.preventDefault();
                    setActiveItem(timelineItems[idx - 1]);
                    timelineItems[idx - 1].focus();
                }
            });

            // attach event listeners to timeline items
            timelineItems.forEach(item => {
                item.addEventListener('mouseenter', () => { setActiveItem(item); });
                item.addEventListener('click', () => {
                    setActiveItem(item);
                    const ripple = document.createElement('div');
                    ripple.className = 'ripple-effect';
                    item.appendChild(ripple);
                    setTimeout(() => ripple.remove(), 1000);
                });
                item.addEventListener('keydown', (e) => {
                    if (e.key === 'enter' || e.key === ' ') {
                        e.preventDefault();
                        setActiveItem(item);
                    }
                });
            });

            // initial activation with staggered animations
            if (timelineItems.length) {
                setTimeout(() => {
                    setActiveItem(timelineItems[0], false);
                    timeline.classList.add('timeline-enter');
                    timelineItems.forEach((item, idx) => {
                        setTimeout(() => item.classList.add('item-enter'), 300 + (idx * 150));
                    });
                }, 300);
            }

            window.addEventListener('resize', () => {
                const active = document.querySelector('#CAREER .timeline-item.active');
                if (active) updateActiveLine(active);
                initTechStack();
            });

            // animated terminal typing for topic cards
            const termIcons = document.querySelectorAll('.animated-terminal-icon .typed-text');
            termIcons.forEach(icon => {
                const txt = 'dev exp >';
                let i = 0;
                function type() {
                    if (i < txt.length) {
                        icon.innerText += txt.charAt(i++);
                        setTimeout(type, 150);
                    } else {
                        setTimeout(() => { icon.innerText = ''; i = 0; type(); }, 1000);
                    }
                }
                type();
            });
        });
    </script>
</section>
