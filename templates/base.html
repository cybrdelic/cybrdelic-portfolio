<!doctype html>
<html lang="en" data-theme="light">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>cybrdelic</title>
    <!-- Centralized CSS file that imports all modules -->
    <link rel="stylesheet" href="/static/css/main.css" />
    <!-- External dependencies -->
    <script src="https://code.iconify.design/2/2.2.1/iconify.min.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/9.3.0/mermaid.min.js"></script>
</head>

<body>
    <!-- Cyberpunk corner effects -->
    <div class="corner-effect corner-top-right"></div>
    <div class="corner-effect corner-bottom-left"></div>
    <div class="scanner"></div>
    
    <div id="terminal">
        <nav class="nav">
            <a href="/" class="home-link">
                <div class="logo">cybrdelic</div>
            </a>
            <div class="nav-left">
                <a href="#projects" class="cmd">ls projects/</a>
                <a href="#whats-next" class="cmd">./future</a>
                <a href="#contact" class="cmd">./contact</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/cybrdelic" target="_blank" class="cmd">git clone</a>
                <a href="#" class="cmd" id="nav-theme-toggle">
                    <span class="toggle-icon">‚òÄÔ∏è</span>
                    <span class="toggle-text">toggle theme</span>
                </a>
            </div>
        </nav>
        {% block content %}{% endblock %}
        <div class="vertical-name"></div>
    </div>

    <!-- Site scripts -->
    <script src="/static/js/animations.js"></script>
    <script src="/static/js/documentation.js"></script>
    <script src="/static/js/projects.js"></script>
    <script src="/static/js/glitch.js"></script>
    <script src="/static/js/transitions.js"></script>

    <!-- Core functionality -->
    <script>
        // Initialize Mermaid diagrams
        mermaid.initialize({
            startOnLoad: true,
            theme: 'neutral',
            flowchart: { curve: 'basis' }
        });

        // Theme management system
        document.addEventListener('DOMContentLoaded', () => {
            const navThemeToggleBtn = document.getElementById('nav-theme-toggle');
            const toggleIcon = document.querySelector('.toggle-icon');
            const cornerEffects = document.querySelectorAll('.corner-effect');
            
            // Function to update theme
            function updateTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                
                // Update toggle icon
                toggleIcon.textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
                
                // Apply subtle animation to corner effects
                cornerEffects.forEach(corner => {
                    corner.style.transition = 'opacity 0.5s ease';
                    corner.style.opacity = '0.5';
                    setTimeout(() => {
                        corner.style.opacity = '0.3';
                    }, 300);
                });
            }
            
            // Initialize theme from saved preference
            const savedTheme = localStorage.getItem('theme') || 'light';
            updateTheme(savedTheme);
            
            // Toggle theme on click
            if (navThemeToggleBtn) {
                navThemeToggleBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const currentTheme = document.documentElement.getAttribute('data-theme');
                    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                    updateTheme(newTheme);
                });
            }
        });

        // Text scramble effect
        function scrambleText(element, newText, duration = 1000) {
            const letters = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
            const oldText = element.textContent;
            const maxLength = Math.max(oldText.length, newText.length);
            const startTime = performance.now();

            function update() {
                const now = performance.now();
                const progress = Math.min((now - startTime) / duration, 1);
                let output = "";
                for (let i = 0; i < maxLength; i++) {
                    if (i < newText.length && progress > i / maxLength) {
                        output += newText[i];
                    } else {
                        output += letters[Math.floor(Math.random() * letters.length)];
                    }
                }
                element.textContent = output;
                if (progress < 1) {
                    requestAnimationFrame(update);
                } else {
                    element.textContent = newText;
                }
            }
            update();
        }

        // Vertical name management
        function morphVerticalName(newText) {
            const vn = document.querySelector('.vertical-name');
            if (vn && vn.textContent !== newText) {
                scrambleText(vn, newText, 200);
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            // Initialize vertical name
            const verticalName = document.querySelector(".vertical-name");
            if (!verticalName) return;
            
            morphVerticalName("cybrdelic");
            
            // Section navigation mapping
            const displayMap = {
                'hero': 'cybrdelic',
                'projects': 'projects',
                'career': 'timeline',
                'whats-next': 'future',
                'contact': 'contact'
            };
            
            // Create intersection observer to detect visible section
            const sectionObserver = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && entry.intersectionRatio > 0.3) {
                        const sectionId = entry.target.getAttribute('id');
                        if (sectionId && verticalName.textContent !== sectionId) {
                            const displayText = displayMap[sectionId] || sectionId;
                            morphVerticalName(displayText);
                        }
                    }
                });
            }, { 
                threshold: [0.3, 0.6],
                rootMargin: "-10% 0px"
            });

            // Force scroll to top on page load
            window.scrollTo(0, 0);
            
            // Smooth scroll navigation
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href');
                    if (targetId === '#') return;
                    
                    const targetElement = document.querySelector(targetId);
                    if (targetElement) {
                        const headerHeight = document.querySelector('.nav')?.offsetHeight || 0;
                        const offsetPosition = targetElement.getBoundingClientRect().top + window.pageYOffset - headerHeight;
                        
                        window.scrollTo({
                            top: offsetPosition,
                            behavior: 'smooth'
                        });
                        
                        history.pushState(null, null, targetId);
                    }
                });
            });
            
            // Active section highlighting in navigation
            const navObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && entry.intersectionRatio > 0.5) {
                        const id = entry.target.getAttribute('id');
                        document.querySelectorAll('.nav a').forEach(link => {
                            link.classList.toggle('active', link.getAttribute('href') === `#${id}`);
                        });
                    }
                });
            }, { threshold: 0.5 });
            
            // Observe all sections for both effects
            document.querySelectorAll("section[id]").forEach(section => {
                sectionObserver.observe(section);
                navObserver.observe(section);
            });
            
            // Update after any dynamic content changes
            document.body.addEventListener("htmx:afterSwap", () => {
                document.querySelectorAll("section[id]").forEach(section => {
                    sectionObserver.observe(section);
                    navObserver.observe(section);
                });
            });
        });
    </script>
</body>
</html>
